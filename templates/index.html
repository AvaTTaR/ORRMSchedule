<!DOCTYPE html>
<html lang="ru">

<head>
  <title>ORRM</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/1000hz-bootstrap-validator/0.11.9/validator.min.js"></script>
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/bootstrap-table.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/bootstrap-table.min.js"></script>
  <script type="text/javascript" src="{{url_for('static', filename='bootstrap-notify.min.js') }}"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/x-editable/1.5.0/bootstrap3-editable/css/bootstrap-editable.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/x-editable/1.5.0/bootstrap3-editable/js/bootstrap-editable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/extensions/editable/bootstrap-table-editable.min.js"></script>
</head>
<style type="text/css">
  body {
    background-color: #E9EAEE;
  }

  .selectwidthauto {
    width: auto !important;
    padding: 0px !important;
    display: initial !important;
    height: auto !important;
  }

  .navbar .navbar-btn {
    position: absolute;
    top: 0px;
    right: 0px;
    margin-right: 15px;
  }

  .nav-tabs {
    &.nav-tabs-alt {
      padding-top: 30px;
      li {
        a {
          color: @brand-info;
          font-size: 16px;
        }
      }
      li.active {
        a {
          background-color: #fff;
          color: @brand-primary !important;
          font-size: 16px;
        }
      }
    }
  }

  .tab-content.tab-content-alt {
    border-right: 1px solid #ddd;
    border-left: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
    border-top-color: transparent;
    border-radius: 0px;
  }

  .tab-content .tab-pane {
    background-color: transparent;
  }

  .tab-content {
    background-color: #fff;
  }

  @media (max-width: 768px) {
    .nav-justified>li {
      display: table-cell;
      width: 1%;
    }
    .nav-justified>li>a {
      border-bottom: 1px solid #ddd !important;
      border-radius: 4px 4px 0 0 !important;
      margin-bottom: 0 !important;
    }
    .nav-tabs.nav-justified>.active>a,
    .nav-tabs.nav-justified>.active>a:hover,
    .nav-tabs.nav-justified>.active>a:focus {
      border-bottom-color: #fff !important;
    }
  }

  .modal {
    text-align: center;
  }

  .modal:before {
    display: inline-block;
    vertical-align: middle;
    content: " ";
    height: 100%;
  }

  .modal-dialog {
    display: inline-block;
    text-align: left;
    vertical-align: middle;
  }

  a.editable {
    font-size: 18px;
    color: black;
  }

  .weekRow {
    font-size: 19px;
  }
</style>
<script>
function checkScrennWidth() {
  if (window.innerWidth < 768) {
    console.log('rest')
    $('#refreshThisWeekButton').html('<i class="glyphicon glyphicon-refresh"></i>');
  } else {
    console.log('test')
    $('#refreshThisWeekButton').html('<i class="glyphicon glyphicon-refresh">Обновить</i>');
  };
};

  $(function() {
    // Schedule tabs
    $('#myTab a:first').tab('show');
    $('.navbar-btn').tab('show');

    checkScrennWidth();

    // Login Modal
    $('#loginModal')
      .on('shown.bs.modal', function(e) {
        $("#inputPassword").focus();
        $('#loginForm').validator().on('submit', function(e) {
          var password = $('#inputPassword').val();
          if (e.isDefaultPrevented()) {
            $('alert').alert();
          } else {
            e.preventDefault();
            $.ajax({
              url: '/',
              type: 'POST',
              data: $('#loginForm').serialize(),
              success: function(result) {
                if (result.status == 'OK') {
                  $('#loginModal').modal('toggle');
                  $('#manageModal').modal('show');
                } else {
                  $('#defaultAlert').alert();
                  $('#passwordGroup').addClass('has-error');
                };
              }
            });
          }
        });
      })
      .on('hidden.bs.modal', function(e) {
        $('#inputPassword').val('');
        $('#loginForm').validator('destroy');
      })

    // Default settings for bootstrap editable
    $.fn.editable.defaults.source = [{
        value: ' ',
        text: ' '
      },
      {
        value: '0',
        text: '0'
      },
      {
        value: '1',
        text: '1'
      },
      {
        value: '2',
        text: '2'
      },
      {
        value: '3',
        text: '3'
      },
      {
        value: 'B',
        text: 'B'
      },
      {
        value: '1/2',
        text: '1/2'
      },
      {
        value: '2/B',
        text: '2/B'
      },
      {
        value: '3/B',
        text: '3/B'
      }
    ]
    $.fn.editable.defaults.mode = 'inline';
    $.fn.editable.defaults.type = 'select';
    $.fn.editable.defaults.showbuttons = false;
    $.fn.editable.defaults.pk = 'shortname';
    $.fn.editable.defaults.url = '/schedule';
    $.fn.editable.defaults.emptytext = '#';
    $.fn.editable.defaults.success = function(response, newValue) {
      if (response.status == 'OK') {
        console.log(response.status);
        $.notify("Расписание изменено", {type: "success"});
      } else {
        console.log(response.status);
      };
    };

    //Bootstrap notify default settings
    $.notifyDefaults({
      allow_dismiss: false,
      z_index: 10031,
      placement: {
        from: "bottom",
        align: "right"
      },
      delay: 1
    });

    //Refresh buttons
    $('#refreshThisWeekButton').click(function() {
      $('#thisWeekTable').bootstrapTable('refresh')
    });
    $('#refreshNextWeekButton').click(function() {
      $('#nextWeekTable').bootstrapTable('refresh')
    });

    // Employee modal
    $('#addEmployeeModal')
      .on('shown.bs.modal', function(e) {
        $("#inputName").focus();
        $('#addEmployeeForm').validator().on('submit', function(e) {
          var name_rus = $('#inputName').val();
          var surname_rus = $('#inputSurname').val();
          if (e.isDefaultPrevented()) {
            $('alert').alert();
          } else {
            e.preventDefault();
            $.ajax({
              url: '/add_employee',
              type: 'POST',
              data: $('#addEmployeeForm').serialize(),
              success: function(result) {
                if (result.status == 'OK') {
                  $.notify("Пользователь добавлен", {type: "success"});
                  $('#addEmployeeModal').modal('toggle');
                  $('#employeeTable').bootstrapTable('refresh');
                  $('#thisWeekTable').bootstrapTable('refresh');
                } else {
                  $.notify("При добавлении пользователя позникла ошибка", {type: "danger"});
                  $('#nameGroup').addClass('has-error');
                  $('#surnameGroup').addClass('has-error');
                };
              }
            });
          }
        });
      })
      .on('hidden.bs.modal', function(e) {
        $('#inputName').val('');
        $('#inputSurname').val('');
        $('#loginForm').validator('destroy');
        $('#defaultAlert').alert();
      })

    // Delete employee button
    $('#deleteEmployeeButton').click(function() {
      $.ajax({
        url: '/delete_employee',
        type: 'POST',
        data: {
          name_rus: $('#employeeTable').bootstrapTable('getSelections')[0]['name_rus'],
          surname_rus: $('#employeeTable').bootstrapTable('getSelections')[0]['surname_rus']
        },
        success: function(result) {
          if (result.status == 'OK') {
            $('#employeeTable').bootstrapTable('refresh');
            $('#thisWeekTable').bootstrapTable('refresh');
            $.notify("Пользователь удалён", {type: "success"});
          } else {
            $.notify("При удалении пользователя позникла ошибка", {type: "danger"});
          };
        }
      });
    })

  });
</script>

<body>
  <nav class="navbar navbar-inverse navbar-static-top" role="navigation">
    <div class="container-fluid" id="navfluid">
      <div class="navbar-header">
        <a class="navbar-brand">Расписание</a>
        <button type="button" class="btn btn-default navbar-btn navbar-right" data-toggle="modal" data-target="#loginModal">Управление</button>
      </div>
    </div>
  </nav>
  <div class="container">
    <ul class="nav nav-tabs nav-justified" id="myTab" role="tablist">
      <li class="nav-item">
        <a class="nav-link" data-toggle="tab" href="#this_week" role="tab" aria-controls="this_week">Текущая неделя</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-toggle="tab" href="#next_week" role="tab" aria-controls="next_week">Следующая неделя</a>
      </li>
    </ul>
    <div class="tab-content tab-content-alt" id="content">
      <div class="tab-pane fade active table-responsive" id="this_week" role="tabpanel">
        <table id="thisWeekTable" data-toggle="table" data-url="/schedule=this" data-id-field="shortname">
          <thead>
            <tr>
              <th data-visible="false"></th>
              <th data-halign="center" id="refreshCell"><button type="button" class="btn btn-default" id="refreshThisWeekButton"></button></th>
              <th data-halign="center" data-valign="middle" class="weekRow">Пн</th>
              <th data-halign="center" data-valign="middle" class="weekRow">Вт</th>
              <th data-halign="center" data-valign="middle" class="weekRow">Ср</th>
              <th data-halign="center" data-valign="middle" class="weekRow">Чт</th>
              <th data-halign="center" data-valign="middle" class="weekRow">Пт</th>
            </tr>
            <tr>
              <th data-field="shortname" data-visible="false"></th>
              <th data-field="name" data-halign="center" data-align="center">Имя</th>
              {% for date in this_week %}
              <th data-field="{{ date }}" data-editable="true" data-valign="middle" data-halign="center" data-align="center">{{ date }}</th>
              {% endfor %}
            </tr>
          </thead>
        </table>
      </div>
      <div class="tab-pane fade active table-responsive" id="next_week" role="tabpanel">
          <table id="nextWeekTable" data-toggle="table" data-url="/schedule=this" data-id-field="shortname">
            <thead>
              <tr>
                <th data-visible="false"></th>
                <th data-halign="center"><button type="button" class="btn btn-default" id="refreshNextWeekButton"><i class="glyphicon glyphicon-refresh">Обновить</i></button></th>
                <th data-halign="center" data-valign="middle" class="weekRow">Пн</th>
                <th data-halign="center" data-valign="middle" class="weekRow">Вт</th>
                <th data-halign="center" data-valign="middle" class="weekRow">Ср</th>
                <th data-halign="center" data-valign="middle" class="weekRow">Чт</th>
                <th data-halign="center" data-valign="middle" class="weekRow">Пт</th>
              </tr>
              <tr>
                <th data-field="shortname" data-visible="false"></th>
                <th data-field="name" data-halign="center" data-align="center">Имя</th>
                {% for date in next_week %}
                <th data-field="{{ date }}" data-editable="true" data-valign="middle" data-halign="center" data-align="center">{{ date }}</th>
                {% endfor %}
              </tr>
            </thead>
          </table>
      </div>
    </div>
  </div>

  <div class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" id="loginModal">
    <div class="modal-dialog modal-sm" role="document">
      <div class="modal-content">
        <form method="post" id="loginForm" data-toggle="validator">
          <div class="modal-header">
            <h4 class="modal-title">Вход</h4>
          </div>
          <div class="modal-body">
            <div class="form-group" id="passwordGroup">
              <input type="password" name="password" class="form-control" id="inputPassword" placeholder="Введите пароль..." required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Отмена</button>
            <button type="submit" class="btn btn-primary">OK</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" tabindex="-1" role="dialog" id="manageModal">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title">Управление</h4>
        </div>
        <div class="modal-body">
          <div id="manageTableToolbar" class="btn-group">
            <button type="button" class="btn btn-default" id="addEmployeeButton" data-toggle="modal" data-target="#addEmployeeModal">
              <i class="glyphicon glyphicon-plus"></i>
            </button>
            <button type="button" class="btn btn-default" id="deleteEmployeeButton">
              <i class="glyphicon glyphicon-trash"></i>
            </button>
          </div>
          <table id="employeeTable" data-toggle="table" data-url="/employees" data-toolbar="#manageTableToolbar" data-show-refresh="true">
            <thead>
              <tr>
                <th data-checkbox="true" data-align="center"></th>
                <th data-field="name_rus" data-halign="center" data-align="center">Имя</th>
                <th data-field="surname_rus" data-halign="center" data-align="center">Фамилия</th>
              </tr>
            </thead>
          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Закрыть</button>
          <button type="button" class="btn btn-primary">Сохранить</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" id="addEmployeeModal">
    <div class="modal-dialog modal-sm" role="document">
      <div class="modal-content">
        <form method="post" id="addEmployeeForm" data-toggle="validator">
          <div class="modal-header">
            <h4 class="modal-title">Добавить</h4>
          </div>
          <div class="modal-body">
            <div class="form-group" id="nameGroup">
              <label for="inputName">Имя</label>
              <input type="text" name="name_rus" class="form-control" id="inputName" required>
            </div>
            <div class="form-group" id="surnameGroup">
              <label for="inputSurname">Фамилия</label>
              <input type="text" name="surname_rus" class="form-control" id="inputSurname" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Отмена</button>
            <button type="submit" class="btn btn-primary">OK</button>
          </div>
        </form>
      </div>
    </div>
  </div>

</body>

</html>
